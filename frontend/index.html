<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Sockets app</title>
  </head>
  <body>
    <header>
      <h1>Web Sockets Chat Application</h1>
      <h3 id="connection-status">Connected to WebSocket server: false</h3>
    </header>
    <main>
      <div class="center">
        <form id="chatroom-selection">
          <label for="chatroom">Select a chatroom:</label>
          <select id="chatroom" name="chatroom">
            <option value="general">General</option>
            <option value="technology">Technology</option>
            <option value="sports">Sports</option>
            <option value="music">Music</option>
          </select>
          <textarea
            id="message-input"
            placeholder="Type your message here..."
          ></textarea>
          <button type="submit">Join Chatroom</button>
        </form>
      </div>

      <!-- add a form with username and password -->
      <div>
        <form id="login-form">
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" required />
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required />
          <button type="submit">Login</button>
        </form>
      </div>
    </main>
    <footer>
      <p>&copy; 2025 Jonathan Gil</p>
    </footer>

    <script>
      let conn;
      let selectedChat = "general";

      class Event {
        constructor(type, payload) {
          this.type = type;
          this.data = payload;
        }
      }

      function routeEvent(event) {
        if (!(event instanceof Event)) {
          console.error("Invalid event:", event);
          return;
        }

        switch (event.type) {
          case "message":
            console.log("New message event:", event.data);
            break;
          default:
            console.log("Unknown event type:", event.type);
        }
      }

      function sendEvent(event) {
        if (!(event instanceof Event)) {
          console.error("Invalid event:", event);
          return;
        }

        if (conn && conn.readyState === WebSocket.OPEN) {
          conn.send(JSON.stringify(event));
        } else {
          console.error("WebSocket connection is not open");
        }
      }

      function changeChatroom(event) {
        event.preventDefault();
        selectedChat = document.getElementById("chatroom").value;
        console.log("Selected chatroom:", selectedChat);

        return false;
      }

      function sendMessage(message) {
        event.preventDefault();
        console.log("Sending message to chatroom:", selectedChat);
        const newMessage = document.getElementById("message-input").value;
        console.log("Message content:", newMessage);
        if (newMessage) {
          const event = new Event("send_message", {
            chatroom: selectedChat,
            message: newMessage,
          });
          sendEvent(event);
          document.getElementById("message-input").value = "";
        }
        return false;
      }

      function login() {
        // grab username and password from the form
        event.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        console.log("Logging in with username:", username);
        console.log("Logging in with password:", password);

        fetch("/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username, password }),
          mode: "cors",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Login successful:", data);
            // maybe store the token in localStorage or a cookie
            connectWebsocket(data.otp);
          })
          .catch((error) => {
            console.error("There was a problem with the login request:", error);
            alert("Login failed: " + error.message);
            return false;
          });
      }

      function connectWebsocket(otp) {
        if (window["WebSocket"]) {
          conn = new WebSocket(`ws://${document.location.host}/ws?otp=${otp}`);

          conn.onopen = function () {
            console.log("WebSocket connection opened");
            document.getElementById("connection-status").innerText =
              "Connected to WebSocket server: true";
          };

          conn.onclose = function (e) {
            console.log("WebSocket connection closed", e);
            document.getElementById("connection-status").innerText =
              "Connected to WebSocket server: false";
          };

          conn.onerror = function (err) {
            console.error("WebSocket error:", err);
          };

          conn.onmessage = function (e) {
            console.log("Message received:", e, e.data);
            const event = JSON.parse(e.data);
            routeEvent(event);
          };
        } else {
          alert("WebSocket is not supported by your browser");
        }
      }

      window.onload = function () {
        document
          .getElementById("chatroom-selection")
          .addEventListener("submit", sendMessage);

        document.getElementById("login-form").onsubmit = login;
      };
    </script>
  </body>
</html>
