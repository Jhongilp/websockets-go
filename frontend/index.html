<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Sockets app</title>
  </head>
  <body>
    <header>
      <h1>Web Sockets Chat Application</h1>
    </header>
    <main>
      <div class="center">
        <form id="chatroom-selection">
          <label for="chatroom">Select a chatroom:</label>
          <select id="chatroom" name="chatroom">
            <option value="general">General</option>
            <option value="technology">Technology</option>
            <option value="sports">Sports</option>
            <option value="music">Music</option>
          </select>
          <textarea
            id="message-input"
            placeholder="Type your message here..."
          ></textarea>
          <button type="submit">Join Chatroom</button>
        </form>
      </div>
    </main>
    <footer>
      <p>&copy; 2025 Jonathan Gil</p>
    </footer>

    <script>
      let conn;
      let selectedChat = "general";

      class Event {
        constructor(type, payload) {
          this.type = type;
          this.data = payload;
        }
      }

      function routeEvent(event) {
        if (!(event instanceof Event)) {
          console.error("Invalid event:", event);
          return;
        }

        switch (event.type) {
          case "message":
            console.log("New message event:", event.data);
            break;
          default:
            console.log("Unknown event type:", event.type);
        }
      }

      function sendEvent(event) {
        if (!(event instanceof Event)) {
          console.error("Invalid event:", event);
          return;
        }

        if (conn && conn.readyState === WebSocket.OPEN) {
          conn.send(JSON.stringify(event));
        } else {
          console.error("WebSocket connection is not open");
        }
      }

      function changeChatroom(event) {
        event.preventDefault();
        selectedChat = document.getElementById("chatroom").value;
        console.log("Selected chatroom:", selectedChat);

        return false;
      }

      function sendMessage(message) {
        event.preventDefault();
        console.log("Sending message to chatroom:", selectedChat);
        const newMessage = document.getElementById("message-input").value;
        console.log("Message content:", newMessage);
        if (newMessage) {
          const event = new Event("message", {
            chatroom: selectedChat,
            message: newMessage,
          });
          sendEvent(event);
          document.getElementById("message-input").value = "";
        }
        return false;
      }

      window.onload = function () {
        document
          .getElementById("chatroom-selection")
          .addEventListener("submit", sendMessage);

        if (window["WebSocket"]) {
          conn = new WebSocket(`ws://${document.location.host}/ws`);

          conn.onmessage = function (e) {
            console.log("Message received:", e, e.data);
            const event = JSON.parse(e.data);
            routeEvent(event);
          };
        } else {
          alert("WebSocket is not supported by your browser");
        }
      };
    </script>
  </body>
</html>
